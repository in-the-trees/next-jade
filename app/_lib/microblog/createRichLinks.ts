"use server";

import * as cheerio from "cheerio";

const createRichLinks = (content_html: string): string => {
   const $ = cheerio.load(`<div class="content-wrapper">${content_html}</div>`);
   const richLinkContainers = $(".rl-container");

   richLinkContainers.each(function () {
      const richLink = $(this).find("blockquote");

      const url = richLink.attr("cite") || "";
      const title = richLink.find(".rl-title").text() || "";
      const snippet = richLink.find(".rl-snippet").text() || "";

      const niceUrl = url.replace(/^(?:https?:\/\/)?(?:www\.)?/i, "");
      const isLocalUrl = "inthetrees.me" === new URL(url).hostname;

      let innerHTML = "";
      if (snippet.length > 0) {
         innerHTML += `
                <p class="rl-snippet">${snippet}</p>
            `;
      }
      innerHTML += `
            <div class="rl-metadata">
                <footer>
                    ${title ? `<span class="rl-title">${title}</span>` : ""}
                    <div class="rl-url-container">
                        <svg
                           xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" >
                           <path fill="currentColor" fill-rule="nonzero" d="M8.23 5.132a3.71 3.71 0 0 1 1.014.33c.28.144.52.318.718.521.567.563.945 1.184 1.132 1.863a3.746 3.746 0 0 1-.003 2.034c-.188.677-.562 1.296-1.121 1.855l-2.378 2.382c-.556.556-1.172.928-1.849 1.116a3.748 3.748 0 0 1-2.033.003c-.68-.186-1.303-.564-1.87-1.132C1.276 13.54.9 12.919.713 12.24a3.745 3.745 0 0 1 .001-2.035c.189-.677.561-1.295 1.119-1.853l1.963-1.953a2.51 2.51 0 0 0-.042.832c.032.289.102.557.211.804l-1.17 1.17c-.385.385-.641.81-.77 1.272-.127.463-.127.928.002 1.393.129.466.386.893.771 1.282.385.385.81.641 1.276.768.465.127.93.126 1.393-.002.463-.128.887-.384 1.272-.77l2.273-2.265c.385-.385.64-.81.767-1.273a2.588 2.588 0 0 0-.004-1.394c-.13-.465-.387-.893-.772-1.281a2.397 2.397 0 0 0-.756-.506 3.455 3.455 0 0 0-1.058-.248l1.04-1.049Zm-.61 5.763a3.668 3.668 0 0 1-1.014-.329 2.81 2.81 0 0 1-.718-.522c-.568-.563-.945-1.184-1.132-1.863a3.752 3.752 0 0 1 .003-2.034c.187-.676.561-1.295 1.122-1.855l2.37-2.375c.561-.56 1.18-.935 1.856-1.123A3.742 3.742 0 0 1 12.14.792c.679.186 1.302.564 1.87 1.131.564.564.94 1.186 1.126 1.865a3.746 3.746 0 0 1 0 2.034c-.188.677-.561 1.295-1.118 1.853L12.054 9.63c.06-.265.074-.542.042-.83a2.77 2.77 0 0 0-.21-.807l1.169-1.17c.384-.384.64-.808.769-1.271a2.568 2.568 0 0 0-.002-1.394c-.128-.465-.385-.89-.77-1.276-.39-.389-.816-.646-1.279-.773a2.573 2.573 0 0 0-1.39.001c-.463.128-.889.385-1.277.77L6.838 5.147c-.385.385-.641.808-.77 1.272A2.563 2.563 0 0 0 6.07 7.81c.129.465.388.893.777 1.282.21.209.462.377.757.505.296.128.648.21 1.058.248l-1.041 1.05Z" />
                        </svg>
                        <cite class="rl-url">${niceUrl}</cite>
                    </div>
                </footer>
                ${
                   !isLocalUrl ?
                      `
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 17 17">
                     <path fill="currentColor" fill-rule="nonzero" d="M3.124 16.872c-.95 0-1.667-.242-2.153-.725-.487-.483-.73-1.194-.73-2.131V3.319c0-.943.243-1.655.73-2.135.486-.48 1.204-.721 2.153-.721h10.644c.949 0 1.667.24 2.153.72.486.481.73 1.193.73 2.136v10.697c0 .937-.244 1.648-.73 2.131-.486.483-1.204.725-2.153.725H3.124Zm8.2-5.836a.69.69 0 0 0 .545-.228c.135-.153.202-.355.202-.607V5.965c0-.317-.082-.55-.246-.699-.164-.15-.39-.224-.677-.224H6.877c-.246 0-.445.069-.598.207a.704.704 0 0 0-.228.549c0 .228.076.411.228.55.153.137.355.206.607.206h1.52l1.257-.14L8.31 7.651l-3.182 3.182a.787.787 0 0 0-.264.58c0 .252.076.451.229.598.152.146.343.22.571.22a.882.882 0 0 0 .343-.066.97.97 0 0 0 .29-.19L9.47 8.796l1.221-1.336-.131 1.31v1.441c0 .258.068.46.206.606.138.147.324.22.558.22Z" />
                  </svg>
              `
                   :  `
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19 19">
                     <path fill="currentColor" fill-rule="nonzero" d="M9.652 18.733a8.774 8.774 0 0 1-3.507-.707 9.166 9.166 0 0 1-2.896-1.964 9.318 9.318 0 0 1-1.964-2.9 8.727 8.727 0 0 1-.712-3.508c0-1.242.238-2.41.712-3.507A9.264 9.264 0 0 1 3.25 3.251a9.279 9.279 0 0 1 2.892-1.964A8.696 8.696 0 0 1 9.644.575c1.248 0 2.42.238 3.515.712a9.318 9.318 0 0 1 4.87 4.86 8.727 8.727 0 0 1 .711 3.507 8.727 8.727 0 0 1-.712 3.507 9.28 9.28 0 0 1-1.968 2.9 9.218 9.218 0 0 1-2.9 1.965 8.774 8.774 0 0 1-3.508.707ZM6.796 7.23a.685.685 0 0 0-.545.232c-.135.156-.202.356-.202.602v4.246c0 .316.082.549.246.698.164.15.39.224.677.224h4.271c.246 0 .445-.068.598-.206a.704.704 0 0 0 .228-.55.704.704 0 0 0-.228-.549c-.153-.137-.355-.206-.607-.206h-1.52l-1.248.14 1.353-1.239 3.182-3.182a.828.828 0 0 0 .255-.588c0-.247-.075-.443-.224-.59a.777.777 0 0 0-.567-.219.865.865 0 0 0-.633.255L8.668 9.479l-1.24 1.327.133-1.31V8.055c0-.252-.07-.453-.207-.602-.138-.15-.324-.224-.558-.224Z"/>
                  </svg>
              `
                }
            </div>
        `;

      const a = $("<a></a>").attr("href", url);
      if (!isLocalUrl) {
         a.attr("target", "_blank");
         a.attr("rel", "noopener noreferrer");
      }

      richLink.html(innerHTML);
      a.append(richLink);
      $(this).append(a);
   });

   return $(".content-wrapper").html() || "";
};

export default createRichLinks;
